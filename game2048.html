<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2048</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: 'Arial', sans-serif;
        padding: 20px;
      }

      .game-container {
        display: flex;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }

      .sidebar {
        width: 250px;
        padding: 30px;
        background: linear-gradient(180deg, #f5f5f5 0%, #e8e8e8 100%);
        display: flex;
        flex-direction: column;
        border-right: 2px solid #ddd;
      }

      h1 {
        color: #333;
        margin-bottom: 20px;
        font-size: 24px;
      }

      .controls {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
        line-height: 1.6;
      }

      .score-board {
        margin-top: auto;
        font-size: 16px;
        font-weight: bold;
      }

      .score-item {
        color: #333;
        margin-bottom: 10px;
      }

      .game-area {
        flex: 1;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .game-board {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        background: #bbada0;
        padding: 10px;
        border-radius: 5px;
        width: 500px;
        height: 500px;
      }

      .tile {
        background: #eee4da;
        border-radius: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 32px;
        font-weight: bold;
        color: #776e65;
        transition: all 0.15s ease-in-out;
      }

      .tile-2 {
        background: #eee4da;
        color: #776e65;
      }

      .tile-4 {
        background: #ede0c8;
        color: #776e65;
      }

      .tile-8 {
        background: #f2b179;
        color: #f9f6f2;
      }

      .tile-16 {
        background: #f59563;
        color: #f9f6f2;
      }

      .tile-32 {
        background: #f67c5f;
        color: #f9f6f2;
      }

      .tile-64 {
        background: #f65e3b;
        color: #f9f6f2;
      }

      .tile-128 {
        background: #edcf72;
        color: #f9f6f2;
        font-size: 28px;
      }

      .tile-256 {
        background: #edcc61;
        color: #f9f6f2;
        font-size: 28px;
      }

      .tile-512 {
        background: #edc850;
        color: #f9f6f2;
        font-size: 28px;
      }

      .tile-1024 {
        background: #edc53f;
        color: #f9f6f2;
        font-size: 24px;
      }

      .tile-2048 {
        background: #edc22e;
        color: #f9f6f2;
        font-size: 24px;
      }

      .game-over {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 40px 60px;
        border-radius: 15px;
        font-size: 24px;
        text-align: center;
        display: none;
        z-index: 1000;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        border: 3px solid #ffd700;
      }

      .game-over button {
        margin-top: 20px;
        padding: 10px 30px;
        font-size: 18px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .game-over button:hover {
        background: #45a049;
      }

      .win-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 40px 60px;
        border-radius: 15px;
        font-size: 24px;
        text-align: center;
        display: none;
        z-index: 1000;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        border: 3px solid #4CAF50;
      }

      .win-message button {
        margin-top: 20px;
        padding: 10px 30px;
        font-size: 18px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .win-message button:hover {
        background: #45a049;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <div class="sidebar">
        <h1>2048</h1>
        <div class="controls">
          <strong>æ“ä½œè¯´æ˜ï¼š</strong><br />
          æ–¹å‘é”® â†‘ â†“ â† â†’ ç§»åŠ¨<br />
          R é‡æ–°å¼€å§‹
        </div>
        <div class="score-board">
          <div class="score-item">å¾—åˆ†: <span id="score">0</span></div>
          <div class="score-item">æœ€é«˜åˆ†: <span id="highScore">0</span></div>
        </div>
      </div>
      <div class="game-area">
        <div id="gameBoard" class="game-board"></div>
      </div>
    </div>
    <div id="gameOver" class="game-over">
      <div>æ¸¸æˆç»“æŸï¼</div>
      <div style="font-size: 18px; margin-top: 10px">æœ€ç»ˆå¾—åˆ†: <span id="finalScore">0</span></div>
      <button onclick="restartGame()">é‡æ–°å¼€å§‹</button>
    </div>
    <div id="winMessage" class="win-message">
      <div>ğŸ‰ æ­å–œï¼ä½ è¾¾åˆ°äº†2048ï¼</div>
      <div style="font-size: 18px; margin-top: 10px">å¾—åˆ†: <span id="winScore">0</span></div>
      <button onclick="continueGame()">ç»§ç»­æ¸¸æˆ</button>
    </div>

    <script>
      const gameBoard = document.getElementById('gameBoard');
      const scoreElement = document.getElementById('score');
      const highScoreElement = document.getElementById('highScore');
      const gameOverElement = document.getElementById('gameOver');
      const winMessageElement = document.getElementById('winMessage');
      const finalScoreElement = document.getElementById('finalScore');
      const winScoreElement = document.getElementById('winScore');

      let board = [];
      let score = 0;
      let highScore = parseInt(localStorage.getItem('2048HighScore') || '0');
      let hasWon = false;

      highScoreElement.textContent = highScore;

      // éŸ³æ•ˆç³»ç»Ÿ
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      let audioEnabled = false;

      function enableAudio() {
        if (!audioEnabled) {
          audioContext.resume();
          audioEnabled = true;
        }
      }

      function playSound(frequency, duration, type = 'sine', volume = 0.15) {
        if (!audioEnabled) return;
        try {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.value = frequency;
          oscillator.type = type;
          gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + duration);
        } catch (e) {}
      }

      function playMoveSound() {
        playSound(200, 0.1, 'sine', 0.1);
      }

      function playMergeSound() {
        playSound(400, 0.15, 'sine', 0.2);
      }

      function playWinSound() {
        playSound(523, 0.2, 'sine', 0.3);
        setTimeout(() => playSound(659, 0.2, 'sine', 0.3), 150);
        setTimeout(() => playSound(784, 0.3, 'sine', 0.3), 300);
      }

      function playGameOverSound() {
        playSound(200, 0.4, 'sawtooth', 0.4);
        setTimeout(() => playSound(150, 0.4, 'sawtooth', 0.4), 300);
      }

      // åˆå§‹åŒ–æ¸¸æˆ
      function initGame() {
        board = [
          [0, 0, 0, 0],
          [0, 0, 0, 0],
          [0, 0, 0, 0],
          [0, 0, 0, 0],
        ];
        score = 0;
        hasWon = false;
        scoreElement.textContent = score;
        addRandomTile();
        addRandomTile();
        renderBoard();
      }

      // æ·»åŠ éšæœºæ–¹å—
      function addRandomTile() {
        const emptyCells = [];
        for (let r = 0; r < 4; r++) {
          for (let c = 0; c < 4; c++) {
            if (board[r][c] === 0) {
              emptyCells.push({ r, c });
            }
          }
        }

        if (emptyCells.length > 0) {
          const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
          board[randomCell.r][randomCell.c] = Math.random() < 0.9 ? 2 : 4;
        }
      }

      // æ¸²æŸ“æ¸¸æˆæ¿
      function renderBoard() {
        gameBoard.innerHTML = '';
        for (let r = 0; r < 4; r++) {
          for (let c = 0; c < 4; c++) {
            const tile = document.createElement('div');
            tile.className = 'tile';
            if (board[r][c] !== 0) {
              tile.textContent = board[r][c];
              tile.classList.add(`tile-${board[r][c]}`);
            }
            gameBoard.appendChild(tile);
          }
        }
      }

      // ç§»åŠ¨è¡Œ
      function moveRow(row) {
        const filtered = row.filter((val) => val !== 0);
        const merged = [];
        let i = 0;

        while (i < filtered.length) {
          if (i < filtered.length - 1 && filtered[i] === filtered[i + 1]) {
            merged.push(filtered[i] * 2);
            score += filtered[i] * 2;
            i += 2;
            playMergeSound();
          } else {
            merged.push(filtered[i]);
            i++;
          }
        }

        while (merged.length < 4) {
          merged.push(0);
        }

        return merged;
      }

      // ç§»åŠ¨å‡½æ•°
      function move(direction) {
        const oldBoard = JSON.parse(JSON.stringify(board));
        let moved = false;

        if (direction === 'left') {
          for (let r = 0; r < 4; r++) {
            const newRow = moveRow(board[r]);
            if (JSON.stringify(board[r]) !== JSON.stringify(newRow)) {
              moved = true;
            }
            board[r] = newRow;
          }
        } else if (direction === 'right') {
          for (let r = 0; r < 4; r++) {
            const reversed = [...board[r]].reverse();
            const newRow = moveRow(reversed).reverse();
            if (JSON.stringify(board[r]) !== JSON.stringify(newRow)) {
              moved = true;
            }
            board[r] = newRow;
          }
        } else if (direction === 'up') {
          for (let c = 0; c < 4; c++) {
            const column = [board[0][c], board[1][c], board[2][c], board[3][c]];
            const newColumn = moveRow(column);
            for (let r = 0; r < 4; r++) {
              if (board[r][c] !== newColumn[r]) {
                moved = true;
              }
              board[r][c] = newColumn[r];
            }
          }
        } else if (direction === 'down') {
          for (let c = 0; c < 4; c++) {
            const column = [board[0][c], board[1][c], board[2][c], board[3][c]].reverse();
            const newColumn = moveRow(column).reverse();
            for (let r = 0; r < 4; r++) {
              if (board[r][c] !== newColumn[r]) {
                moved = true;
              }
              board[r][c] = newColumn[r];
            }
          }
        }

        if (moved) {
          playMoveSound();
          addRandomTile();
          scoreElement.textContent = score;

          if (score > highScore) {
            highScore = score;
            highScoreElement.textContent = highScore;
            localStorage.setItem('2048HighScore', highScore.toString());
          }

          // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°2048
          if (!hasWon) {
            for (let r = 0; r < 4; r++) {
              for (let c = 0; c < 4; c++) {
                if (board[r][c] === 2048) {
                  hasWon = true;
                  playWinSound();
                  winScoreElement.textContent = score;
                  winMessageElement.style.display = 'block';
                }
              }
            }
          }

          renderBoard();

          // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
          if (isGameOver()) {
            setTimeout(() => {
              gameOver();
            }, 300);
          }
        }
      }

      // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
      function isGameOver() {
        // æ£€æŸ¥æ˜¯å¦æœ‰ç©ºæ ¼
        for (let r = 0; r < 4; r++) {
          for (let c = 0; c < 4; c++) {
            if (board[r][c] === 0) return false;
          }
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆå¹¶
        for (let r = 0; r < 4; r++) {
          for (let c = 0; c < 4; c++) {
            if (
              (r < 3 && board[r][c] === board[r + 1][c]) ||
              (c < 3 && board[r][c] === board[r][c + 1])
            ) {
              return false;
            }
          }
        }

        return true;
      }

      // æ¸¸æˆç»“æŸ
      function gameOver() {
        playGameOverSound();
        finalScoreElement.textContent = score;
        gameOverElement.style.display = 'block';
      }

      // é‡æ–°å¼€å§‹
      function restartGame() {
        gameOverElement.style.display = 'none';
        winMessageElement.style.display = 'none';
        initGame();
      }

      // ç»§ç»­æ¸¸æˆ
      function continueGame() {
        winMessageElement.style.display = 'none';
      }

      // é”®ç›˜æ§åˆ¶
      document.addEventListener('keydown', (e) => {
        enableAudio();

        if (e.code === 'ArrowLeft') {
          e.preventDefault();
          move('left');
        } else if (e.code === 'ArrowRight') {
          e.preventDefault();
          move('right');
        } else if (e.code === 'ArrowUp') {
          e.preventDefault();
          move('up');
        } else if (e.code === 'ArrowDown') {
          e.preventDefault();
          move('down');
        } else if (e.code === 'KeyR' || e.code === 'Keyr') {
          restartGame();
        }
      });

      document.addEventListener('click', enableAudio, { once: true });

      // åˆå§‹åŒ–
      initGame();
    </script>
  </body>
</html>

